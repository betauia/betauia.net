---
import type { GetStaticPaths } from "astro";
import Container from "@components/containers/Container.astro";
import PageLayout from "@layouts/PageLayout.astro";
import SortList from "@components/ui/SortList.astro";

import fs from "fs";
import path from "path";

export const getStaticPaths = (() => {
  const subjectsDir = path.resolve("src/content/exams");
  const folders = fs
    .readdirSync(subjectsDir)
    .filter(name => fs.statSync(path.join(subjectsDir, name)).isDirectory());

  return folders.map(subject => ({
    params: { subject },
  }));
}) satisfies GetStaticPaths;

const { subject } = Astro.params;

const pdfImports = import.meta.glob<{ default: string }>("@content/exams/*/*.pdf", {
  eager: true,
});

const pdfFiles = Object.entries(pdfImports)
  .filter(([path]) => path.includes(`/${subject}/`))
  .map(([path, mod]) => {
    const fileName: string | undefined = path.split("/").pop();
    // Ensure that pdf file names follow -> year-semester-score-subject.pdf format
    // year -> yyyy
    // examNumber -> 1...?
    // score -> 0...100
    //nickname -> nickname_with_underscores_for_spaces
    const [year, examNumber, score, nickname, ...rest] =
      fileName?.replace(".pdf", "").split("-") || [];

    return {
      name: fileName,
      href: mod.default,
      year: year,
      examNumber: examNumber,
      score: score,
      nickname: nickname,
    };
  });
---

<PageLayout title="Exams">
  <Container>
    <div class="text-center font-bold">
      <h1 class="pb-6 text-2xl">Tilgjengelige eksamensoppgaver for {subject}</h1>
    </div>
    <SortList files={pdfFiles} />
  </Container>
</PageLayout>
