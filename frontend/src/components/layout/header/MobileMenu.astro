---
import { Icon } from "astro-icon/components";
import Button from "@components/ui/Button.astro";
import { navigationDropdowns } from "@data/navBarConfig";
---

<button
  id="mobile-menu-button"
  class="group flex items-center justify-center p-2 md:hidden"
  type="button"
  aria-expanded="false"
  aria-label="Toggle mobile menu"
>
  <div class="relative h-5 w-6">
    <span
      class="hamburger-line h-0.75 absolute left-0 top-0 block h-[3px] w-full rounded-full bg-fg-muted transition-all duration-200 ease-out group-hover:bg-fg-base dark:bg-dark-fg-muted dark:group-hover:bg-dark-fg-base"
    ></span>
    <span
      class="hamburger-line h-0.75 absolute left-0 top-2 block h-[3px] w-full rounded-full bg-fg-muted transition-all duration-200 ease-out group-hover:bg-fg-base dark:bg-dark-fg-muted dark:group-hover:bg-dark-fg-base"
    ></span>
    <span
      class="hamburger-line h-0.75 absolute left-0 top-4 block h-[3px] w-full rounded-full bg-fg-muted transition-all duration-200 ease-out group-hover:bg-fg-base dark:bg-dark-fg-muted dark:group-hover:bg-dark-fg-base"
    ></span>
  </div>
</button>

<div
  id="mobile-menu"
  class="fixed inset-x-0 top-16 z-30 max-h-0 overflow-hidden bg-bg-raised pb-2 opacity-0 shadow-lg transition-[max-height,opacity] duration-300 ease-out dark:bg-dark-bg-base md:hidden"
>
  <nav class="mx-auto max-w-6xl px-4 py-4">
    {
      navigationDropdowns.map(dropdown => (
        <div class="border-b border-fg-muted py-3 last:border-b-0 dark:border-dark-bg-raised">
          <button
            class="mobile-dropdown-toggle flex w-full items-center justify-between text-left text-fg-base transition-colors hover:text-fg-muted dark:text-dark-fg-base dark:hover:text-dark-fg-muted"
            data-target={dropdown.id}
            type="button"
            aria-expanded="false"
          >
            <span class="font-medium">{dropdown.label}</span>
            <Icon name="fa-solid:chevron-down" class="h-4 w-4 transition-transform duration-200" />
          </button>

          <div
            id={`mobile-dropdown-${dropdown.id}`}
            class="max-h-0 overflow-hidden transition-[max-height] duration-300 ease-out"
          >
            <ul class="mt-4 space-y-2 pl-2">
              {dropdown.items.map(item => (
                <li>
                  <a
                    href={item.href}
                    class="flex items-start gap-4 rounded-lg p-2 text-sm transition-colors hover:bg-bg-base dark:hover:bg-dark-bg-raised"
                  >
                    <Icon name={item.icon} class="mt-0.5 h-4 w-4 flex-shrink-0 text-accent" />
                    <div>
                      <div class="font-medium text-fg-base dark:text-dark-fg-base">
                        {item.title}
                      </div>
                      <div class="text-xs text-fg-muted dark:text-dark-fg-muted">{item.desc}</div>
                    </div>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </div>
      ))
    }

    <div class="mt-2 pt-4">
      <!-- Show when not logged in -->
      <div id="mobile-login-btn">
        <a
          href="/login"
          class="flex w-full items-center justify-center gap-2 rounded-md border border-fg-muted bg-bg-raised px-4 py-2 font-medium text-fg-base transition-all hover:text-fg-muted hover:shadow-md dark:border-dark-fg-muted dark:bg-dark-bg-raised dark:text-dark-fg-base dark:hover:text-dark-fg-muted"
        >
          <Icon name="fa-solid:user" class="h-4 w-4" />
          <span>Logg inn</span>
        </a>
      </div>
      <!-- Show when logged in -->
      <div id="mobile-user-menu" class="hidden space-y-2">
        <a
          href="/account"
          class="flex w-full items-center justify-center gap-2 rounded-md border border-fg-muted bg-bg-raised px-4 py-2 font-medium text-fg-base transition-all hover:text-fg-muted hover:shadow-md dark:border-dark-fg-muted dark:bg-dark-bg-raised dark:text-dark-fg-base dark:hover:text-dark-fg-muted"
        >
          <Icon name="fa-solid:user-circle" class="h-4 w-4" />
          <span>Min konto</span>
        </a>
        <button
          id="mobile-logout-btn"
          type="button"
          class="flex w-full items-center justify-center gap-2 rounded-md border border-fg-muted bg-bg-raised px-4 py-2 font-medium text-fg-base transition-all hover:text-fg-muted hover:shadow-md dark:border-dark-fg-muted dark:bg-dark-bg-raised dark:text-dark-fg-base dark:hover:text-dark-fg-muted"
        >
          <Icon name="fa-solid:sign-out-alt" class="h-4 w-4" />
          <span>Logg ut</span>
        </button>
      </div>
    </div>
  </nav>
</div>

<style>
  #mobile-menu-button[aria-expanded="true"] .hamburger-line:nth-child(1) {
    transform: translateY(8px) rotate(45deg);
  }

  #mobile-menu-button[aria-expanded="true"] .hamburger-line:nth-child(2) {
    opacity: 0;
  }

  #mobile-menu-button[aria-expanded="true"] .hamburger-line:nth-child(3) {
    transform: translateY(-8px) rotate(-45deg);
  }
</style>

<script>
  import { isLoggedIn, logout } from "@lib/auth";

  function updateMobileAuth() {
    const loginBtn = document.getElementById("mobile-login-btn");
    const userMenu = document.getElementById("mobile-user-menu");

    if (loginBtn && userMenu) {
      if (isLoggedIn()) {
        loginBtn.classList.add("hidden");
        userMenu.classList.remove("hidden");
      } else {
        loginBtn.classList.remove("hidden");
        userMenu.classList.add("hidden");
      }
    }
  }

  // Run on initial load
  updateMobileAuth();

  // Listen for auth state changes
  document.addEventListener("auth:changed", updateMobileAuth);

  // Handle logout button click
  const logoutBtn = document.getElementById("mobile-logout-btn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => {
      logout();
    });
  }
</script>
